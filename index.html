<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>JavaScript Unit Testing</title>
    <link rel="stylesheet" href="styles/styles.css"/>
  </head>
  <body class="cube">
    <article>
      <section>
        <h1>JavaScript Unit Testing</h1><img src="images/dilberttestscript.jpg" width="597">
      </section>
      <section>
        <h2>Why should we automate client side testing?</h2>
        <div class="imagebox"><img src="images/bigquestionmark.png" width="150" class="float-left">
          <div class="sidebar">Many of the same reasons we test our server side code</div>
        </div>
      </section>
      <section>
        <h2>Verify Expectations</h2>
        <ul>
          <li></li>
          <li>Happy path<i class="fa fa-thumbs-up icon-padding"></i></li>
          <li>Error conditions<i class="fa fa-thumbs-down icon-padding"></i></li>
          <li>Invalid input<i class="fa fa-times icon-padding"></i></li>
          <li>Unexpected input<i class="fa fa-warning icon-padding"></i></li>
        </ul>
      </section>
      <section>
        <h2>Prevent regressions</h2><img src="images/gorilla-callout.png" width="500">
      </section>
      <section>
        <h2>Also known as...</h2>
        <h2>Whack-a-mole!</h2><img src="images/whackamole.jpg">
      </section>
      <section>
        <h2>Document Specs</h2>
        <hr>
        <pre><code class="language-javascript">// Assume passwordValidator module has been loaded...
describe('Password Validator', function() {
  it('Rejects short passwords', function() {
    var password = 'foo';
    var result = passwordValidator.isValid(password);
    expect(result).to.be(false);
  });
  it('Accepts password with mixed chars', function() {
    var password = 'abc123*&^%FEG'
    var result = passwordValidator.isValid(password);
    expect(result).to.be(true);
  });
});
</code></pre>
      </section>
      <section>
        <h2>Refactor with Confidence</h2><img src="images/confidence.png" width="370" height="400">
      </section>
      <section>
        <h2>Leads to cleaner code</h2>
        <div class="imagebox"><img src="images/clean-code-circle.png" width="200" height="200" class="img-padding"><img src="images/no-fish-circle.png" width="210" height="210" class="img-padding"></div>
        <h3>If it's hard to test, that's a code smell</h3>
      </section>
      <section>
        <h2>In the words of Uncle Bob...</h2>
        <blockquote cite="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">Why don't we clean up code that we know is messy? We're afraid we'll break it. But if we have the tests, we can be reasonably sure that the code is not broken, or that we'll detect the breakage immediately. If we have the tests we become fearless about making changes. If we see messy code, or an unclean structure, we can clean it without fear. Because of the tests, the code becomes malleable again. Because of the tests, software becomes soft again.</blockquote>
      </section>
      <section>
        <h2>JavaScript specific testing challenges</h2>
        <ul>
          <li></li>
          <li>What are the units?</li>
          <li>Asynchronous execution</li>
          <li>DOM manipulation</li>
        </ul>
      </section>
      <section>
        <h2>What are the units?</h2>
        <pre><code class="language-javascript">$('button').click(function() {
  var query = $('input').text();
  // Validation rule: only search if we have a query of at least two chars
  if (query && query.length >= 2) {
    $.ajax(url: 'http://content.guardianapis.com/search?show-fields=all&q=' + query, success: function(data) {
      var items = data.response.results;
      for (i = 0; i < items; i++) {
        // Business rule: only show news items that have pictures
        if (item.fields.thumbnail) {
          // sentiment is a global!
          sentimentResult = sentiment.analyze(item.fields.trailText);
          $('table').append('&lt;tr&gt;')
          $('table').append('&lt;td&gt;' + item.fields.byline + '&lt;/tr&gt;')  // author
          $('table').append('&lt;td&gt;' + item.fields.trailText + '&lt;/tr&gt;')  // content
          $('table').append('&lt;td&gt;' + item.fields.thumbnail + '&lt;/tr&gt;')  // thumbnail
          $('table').append('&lt;td&gt;' + item.fields.webUrl + '&lt;/tr&gt;')  // url
          $('table').append('&lt;td&gt;' + item.fields.webTitle + '&lt;/tr&gt;')  // title
          $('table').append('&lt;td&gt;' + item.fields.webPublicationDate + '&lt;/tr&gt;')  // publishDate
          $('table').append('&lt;td&gt;' + sentimentResult + '&lt;/tr&gt;')  // sentiment analysis
          $('table').append('&lt;/tr&gt;')
        }
      }
    }, error: function(jqXHR, textStatus, errorThrown) {
      $('.errorBox').text(textStatus + ', ' + errorThrown);
      $('.errorBox').show();
    });
  }
});
</code></pre>
      </section>
      <section>
        <h2>Use a module system</h2>
        <pre><code class="language-javascript">// News Module
define(['jquery', 'sentiment'], function($, sentiment) {
  var init = function(config) {
    // pass in DOM elems, register event handlers
  },
  var validate = function(query) {
    // validation rules implemented here
  },
  var load = function(query) {
    // $.ajax...
  },
  var process = function(items) {
    // for each item, pass content to sentiment analysis
  },
  var display = function(displayItems, config.outputTarget) {
    // dom manipulation...
  }
  // Expose methods
  return {
    init: init,
    validate: validate,
    load: load,
    process: process,
    display: display
  }
});
</code></pre>
      </section>
      <section>
        <h2>A stack for JS testing</h2>
        <ul>
          <li></li>
          <li><a href="http://visionmedia.github.io/mocha/">Mocha test framework</a> describe... it...</li>
          <li><a href="http://chaijs.com/api/bdd/">Chai Assertion Library</a> expect... to...</li>
          <li><a href="http://sinonjs.org/docs/">Sinon.JS</a> spies, stubs, and mocks</li>
          <li><a href="http://karma-runner.github.io/0.12/intro/how-it-works.html">Karma Runner</a> Multiple browsers, reporters</li>
        </ul>
      </section>
      <section>
        <h2>Load module in a test</h2>
        <pre><code class="language-javascript">// News module is the fixture under test
define(['../news', 'jquery'], function(fixture, $) {
  // Can call methods of news module,
  // such as example fixture.init, fixture.validate etc.
});
</code></pre>
      </section>
      <section>
        <h2>Test validation</h2>
        <pre><code class="language-javascript">define(['../news', 'jquery'], function(fixture, $) {
  describe('validate', function() {
    it('Does not allow null query', function() {
      expect(fixture.validate(null)).to.be(false);
    });
    it('Does not allow null short query', function() {
      expect(fixture.validate('a')).to.be(false);
    });
    it('Allows query string of 2 characters', function() {
      expect(fixture.validate('ab')).to.be(true);
    });
  });
});
</code></pre>
      </section>
      <section>
        <h2>Mock out dependencies</h2>
        <pre><code class="language-javascript">define(['../news', '../sentiment'], function(fixture, sentiment) {
  it('News conversion delegates to sentiment analysis', function() {
  
    var sentimentStub = sinon.stub(sentiment, 'analyze');
    sentimentStub.onCall(0).returns('positive');
    sentimentStub.onCall(2).returns('negative');
    
    var itemsFromApi = [{content: 'foo'}, {content: 'bar'}];
    var result = fixture.process(itemsFromApi);
    
    sinon.assert.calledwith(sentimentStub, 'foo')
    sinon.assert.calledwith(sentimentStub, 'bar')
  });
});
</code></pre>
      </section>
      <section>
        <h2>Asynchronous: Promises</h2>
        <pre><code class="language-javascript">var load = function(query) {
  return $.ajax({
    url: 'http://content.guardianapis.com/search?show-fields=all',
    data: {
      q: query
    }
  }).promise();
};
var process = function(query) {
  var d = $.Deferred();
  load(query).then(
    function (data) {
      // foreach data item, process
      d.resolve(processedData);
    },
    function(jqXHR, statusText, errorThrown) {
      // handle error
      d.reject(statusText + ' ' + errorThrown);
    }
  )
};
</code></pre>
      </section>
      <section>
        <h2>Mock out async</h2>
        <pre><code class="language-javascript">it('Process news calls guardian API', function(done) {
  var ajaxResponse = function() {
    var d = $.Deferred();
    d.resolve({news: [{item1, item2, etc.}]});
    return d.promise();
  };
  var ajaxStub = sandbox.stub($, 'ajax');
  ajaxStub.returns(ajaxResponse());
  
  // Verify promise is returned
  result = fixture.process('election');
  expect(result.state()).to.equal('resolved');
  
  // Verify ajax stub was called with matcher
  sinon.assert.calledWith(ajaxStub, sinon.match({
    url: 'http://content.guardianapis.com/search?show-fields=all'
  }));
  
  // Verify processing result
  result.then(
    function(data) {
      // expect(data).to... Verify data contents
      done();
    },
    function(err) {
      // Should not get here because this is a success test
      expect(false).to.be(true);
      done();
    }
  );
});
</code></pre>
      </section>
      <!-- TODO: dom manipulation example - karma html2js plugin-->
      <section>
        <h2>Further References</h2>
        <ul>
          <li>TBD...</li>
        </ul>
      </section>
      <section data-bespoke-hash="named-route">
        <h2>Named Route</h2>
        <h3>Powered by <a href="https://github.com/markdalgleish/bespoke-hash">bespoke-hash</a></h3>
        <p>Look up! This route has been named with a <em>'data-bespoke-hash'</em> attribute.</p>
      </section>
      <section data-bespoke-state="emphatic">
        <h2>Emphatic Slide!</h2>
        <h3>Powered by <a href="https://github.com/markdalgleish/bespoke-state">bespoke-state</a></h3>
      </section>
    </article>
    <script src="scripts/scripts.js"></script>
  </body>
</html>